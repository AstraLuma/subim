#!/usr/bin/python
# -*- coding: utf-8 -*-
import pygtk
pygtk.require('2.0')
import gtk
import gtk.glade
import gobject
import os, sys, socket, struct

IPV6 = socket.has_ipv6

print "IPv6", IPV6

SUBIM_PORT = 5349 # map(hex, map(ord, 'SI')), SI = SubIM
if IPV6:
	CAST_IP = 'ff05::1'
else:
	CAST_IP = '<broadcast>'
	#CAST_IP = '255.255.255.255'
	#CAST_IP = '224.0.0.1'


def resource(fn):
	if os.path.exists(os.path.join('/usr/lib/subim', fn)):
		return os.path.join('/usr/lib/subim', fn)
	else:
		return fn

_hostname = None
def getHost():
	global _hostname
	if _hostname is None:
		_hostname = socket.gethostname()
	return _hostname

def getColorForUser(user):
	return 'red'

HEADER_FORMAT = "!HL"
ARGUMENT_FORMAT = "!L"

CMD_MESSAGE = 0
CMD_USER_JOIN = 1
CMD_USER_PART = 2

class Protocol(object):
	sock = None
	
	def __init__(self):
		self.sock = socket.socket(socket.AF_INET6 if IPV6 else socket.AF_INET, socket.SOCK_DGRAM)
		self.sock.connect((CAST_IP, SUBIM_PORT))
	
	def __readHeader(self):
		l = struct.calcsize(HEADER_FORMAT)
		d = self.sock.read(l)
		cmd, ulen = struct.unpack(HEADER_FORMAT, d)
		user = self.sock.read(ulen)
		return cmd, user
	
	def __readArgument(self):
		l = struct.calcsize(ARGUMENT_FORMAT)
		d = self.sock.read(l)
		ulen, = struct.unpack(ARGUMENT_FORMAT, d)
		data = self.sock.read(ulen)
		return data
	
	def sendMessage(self, msg):
		print "Protocol.sendMessage", msg
		user = getHost()
		data = struct(HEADER_FORMAT, CMD_MESSAGE, len(user))
		data += user
		data += struct(ARGUMENT_FORMAT, len(msg))
		data += msg
		self.sock.sendall(data)
	
	def recieveMessage(self, user, msg):
		print "Protocol.recieveMessage", user, msg
	
	def userJoin(self, user):
		print "Protocol.userJoin", user
	
	def userPart(self, user):
		print "Protocol.userPart", user
	
	def listUsers(self):
		print "Protocol.listUsers"

class MainWindow(object):
	def __init__(self, fn):
		self.xml = gtk.glade.XML(fn, 'wSubIM')
		self.xml.signal_autoconnect(self)
		self._win = self.xml.get_widget('wSubIM')
		self._msg = self.xml.get_widget('tvMessage')
		self._hist = self.xml.get_widget('tvHistory')
		self._users = self.xml.get_widget('tvUsers')
		self._users.set_model(gtk.ListStore(str))
		self.umodel = self._users.get_model()
		self.umodel.set_sort_column_id(0, gtk.SORT_ASCENDING)
		self._users.sensitive = True
	
	def winDelete(self, widget, event):
		print "winDelete", widget, event
		gtk.main_quit(0)
	
	def present(self):
		self._win.present()
	
	def getMessageText(self):
		buf = self._msg.get_buffer()
		return buf.get_text(*buf.get_bounds())
	
	def sendMessage(self, *p, **kw):
		print "TODO: sendMessage", p, kw
		protocol.sendMessage(self.getMessageText())
		self.addMessage(getHost(), self.getMessageText())
		# Clear the input
		buf = self._msg.get_buffer()
		buf.delete(*buf.get_bounds())
		# Scroll to the bottom
		va = self.xml.get_widget('swHistory').get_vadjustment()
		va.set_value(va.upper)
	
	def addUser(self, userName):
		print "TODO: addUser", userName
		i = self.umodel.append([userName])
		print "addUser:i", self.umodel.get_path(i)
		self._users.sensitive = True
		print "addUser:model", map(list,self.umodel)
		print "addUser:sense", self._users.get_model(), self.umodel
	
	def rmUser(self, user):
		print "TODO: rmUser", userName
		for i in range(0, len(self.umodel)):
			if self.umodel[i][0] == user:
				del self.umodel[i]
				return
	
	_first = True
	def addMessage(self, user, msg):
		buf = self._hist.get_buffer()
		if not self._first:
			buf.insert(buf.get_bounds()[1], "\n")
		self._first = False
		ut = buf.create_tag(foreground=getColorForUser(user))
		buf.insert_with_tags(buf.get_bounds()[1], user+":", ut)
		buf.insert(buf.get_bounds()[1], " "+msg.strip())
	

if __name__ == '__main__':
	app = MainWindow(resource('subim.glade'))
	print repr(app)
	protocol = Protocol()
	# FIXME: Add event handlers
	protocol.listUsers()
	app.addUser(getHost())
	app.addUser(getHost())
	app.addUser(getHost())
	
	app.present()
	gtk.main()
